<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Perfil do usuário - NEXON FITNESS">
  <title>Perfil - NEXON FITNESS</title>
  <!-- Fontes e Ícones -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Audiowide&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Estilos -->
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/chatbot.css">
  <style>
    body {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: white;
      font-family: 'Poppins', sans-serif;
    }

    .profile-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 120px 20px 40px;
    }

    .profile-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .profile-avatar {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: linear-gradient(135deg, #bc13fe, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 60px;
      color: white;
      border: 3px solid rgba(188, 19, 254, 0.3);
    }

    .profile-name {
      font-size: 2.5rem;
      font-weight: 600;
      color: #bc13fe;
      margin-bottom: 10px;
    }

    .profile-email {
      font-size: 1.2rem;
      color: #888;
      margin-bottom: 20px;
    }

    .profile-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: rgba(26, 26, 26, 0.8);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 1px solid rgba(188, 19, 254, 0.2);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      border-color: #bc13fe;
      box-shadow: 0 0 20px rgba(188, 19, 254, 0.3);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #bc13fe;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #aaa;
    }

    .profile-content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 40px;
    }

    .profile-sidebar {
      background: rgba(26, 26, 26, 0.8);
      border-radius: 12px;
      padding: 30px;
      border: 1px solid rgba(188, 19, 254, 0.2);
    }

    .profile-main {
      background: rgba(26, 26, 26, 0.8);
      border-radius: 12px;
      padding: 30px;
      border: 1px solid rgba(188, 19, 254, 0.2);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #bc13fe;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #fff;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.3);
      color: white;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #bc13fe;
      box-shadow: 0 0 10px rgba(188, 19, 254, 0.5);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .goals-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .goal-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .goal-checkbox input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .goal-checkbox label {
      margin: 0;
      font-size: 14px;
      cursor: pointer;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #bc13fe, #8b5cf6);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(188, 19, 254, 0.4);
    }

    .btn-secondary {
      background: transparent;
      color: #bc13fe;
      border: 1px solid #bc13fe;
    }

    .btn-secondary:hover {
      background: #bc13fe;
      color: white;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .subscription-info {
      background: linear-gradient(135deg, rgba(188, 19, 254, 0.1), rgba(139, 92, 246, 0.1));
      border: 1px solid rgba(188, 19, 254, 0.3);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .subscription-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-active {
      background: #10b981;
      color: white;
    }

    .status-inactive {
      background: #6b7280;
      color: white;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      color: #bc13fe;
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      color: #ef4444;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .success-message {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid #10b981;
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .profile-content {
        grid-template-columns: 1fr;
      }

      .profile-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .goals-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header com Menu de Navegação -->
  <header class="navbar">
    <div class="nav-container">
      <div class="logo">
        <p class="logo-text">NEXON FITNESS</p>
      </div>
      <button class="mobile-menu-btn" aria-label="Abrir menu de navegação" aria-expanded="false">
        <span class="menu-icon"></span>
      </button>
      <nav>
        <ul class="nav-links">
          <li><a href="../index.html">Início</a></li>
          <li><a href="../index.html#sobre">Sobre</a></li>
          <li><a href="../index.html#planos">Planos</a></li>
          <li><a href="../index.html#planilhas">Planilhas</a></li>
          <li><a href="../index.html#contato">Contato</a></li>
          <li><a href="../index.html#blog">Blog</a></li>
          <li class="nav-profile">
            <button id="profile-btn" class="profile-btn" aria-label="Abrir menu de perfil" aria-haspopup="true" aria-expanded="false">
              <i class="fas fa-user-circle"></i>
            </button>
            <div id="profile-menu" class="profile-menu">
              <a href="profile.html" class="profile-menu-item">
                <i class="fas fa-user" style="margin-right: 8px; width: 16px;"></i>
                Perfil
              </a>
              <a href="settings.html" class="profile-menu-item">
                <i class="fas fa-cog" style="margin-right: 8px; width: 16px;"></i>
                Configurações
              </a>
              <a href="login.html" class="profile-menu-item login">
                <i class="fas fa-sign-in-alt" style="margin-right: 8px; width: 16px;"></i>
                Entrar
              </a>
            </div>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="profile-container">
    <!-- Loading State -->
    <div id="loading" class="loading" style="display: none;">
      <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
    </div>

    <!-- Error Message -->
    <div id="error-message" class="error-message" style="display: none;"></div>

    <!-- Success Message -->
    <div id="success-message" class="success-message" style="display: none;"></div>

    <!-- Profile Content -->
    <div id="profile-content" style="display: none;">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-user"></i>
        </div>
        <h1 class="profile-name" id="user-name">Carregando...</h1>
        <p class="profile-email" id="user-email">Carregando...</p>
      </div>

      <div class="profile-stats">
        <div class="stat-card">
          <div class="stat-number" id="workouts-completed">0</div>
          <div class="stat-label">Treinos Completados</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-time">0h</div>
          <div class="stat-label">Tempo Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="current-streak">0</div>
          <div class="stat-label">Sequência Atual</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="user-bmi">--</div>
          <div class="stat-label">IMC</div>
        </div>
      </div>

      <div class="profile-content">
        <div class="profile-sidebar">
          <div class="subscription-info">
            <div class="section-title">
              <i class="fas fa-crown"></i>
              Assinatura
            </div>
            <div class="subscription-status">
              <span id="subscription-plan">Carregando...</span>
              <span id="subscription-status" class="status-badge status-inactive">INATIVO</span>
            </div>
            <p id="subscription-dates">Carregando...</p>
            <a href="../pages/assinar-premium.html" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Upgrade</a>
          </div>

          <div class="section-title">
            <i class="fas fa-chart-line"></i>
            Progresso
          </div>
          <p>Seus dados de progresso aparecerão aqui em breve.</p>
        </div>

        <div class="profile-main">
          <div class="section-title">
            <i class="fas fa-user-edit"></i>
            Informações Pessoais
          </div>

          <form id="profile-form">
            <div class="form-group">
              <label for="name">Nome</label>
              <input type="text" id="name" name="name" required>
            </div>

            <div class="form-group">
              <label for="bio">Bio</label>
              <textarea id="bio" name="profile.bio" placeholder="Conte um pouco sobre você..."></textarea>
            </div>

            <div class="form-group">
              <label for="location">Localização</label>
              <input type="text" id="location" name="profile.location" placeholder="Cidade, Estado">
            </div>

            <div class="form-group">
              <label for="website">Website</label>
              <input type="url" id="website" name="profile.website" placeholder="https://seu-site.com">
            </div>

            <div class="section-title" style="margin-top: 30px;">
              <i class="fas fa-dumbbell"></i>
              Dados Físicos
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div class="form-group">
                <label for="height">Altura (cm)</label>
                <input type="number" id="height" name="fitness.height" min="50" max="250" placeholder="175">
              </div>

              <div class="form-group">
                <label for="weight">Peso (kg)</label>
                <input type="number" id="weight" name="fitness.weight" min="20" max="300" placeholder="70">
              </div>
            </div>

            <div class="form-group">
              <label for="birthDate">Data de Nascimento</label>
              <input type="date" id="birthDate" name="fitness.birthDate">
            </div>

            <div class="form-group">
              <label for="level">Nível de Condicionamento</label>
              <select id="level" name="fitness.level">
                <option value="iniciante">Iniciante</option>
                <option value="intermediario">Intermediário</option>
                <option value="avancado">Avançado</option>
              </select>
            </div>

            <div class="form-group">
              <label>Objetivos</label>
              <div class="goals-grid">
                <div class="goal-checkbox">
                  <input type="checkbox" id="perda-peso" name="fitness.goals" value="perda-peso">
                  <label for="perda-peso">Perda de Peso</label>
                </div>
                <div class="goal-checkbox">
                  <input type="checkbox" id="ganho-massa" name="fitness.goals" value="ganho-massa">
                  <label for="ganho-massa">Ganho de Massa</label>
                </div>
                <div class="goal-checkbox">
                  <input type="checkbox" id="condicionamento" name="fitness.goals" value="condicionamento">
                  <label for="condicionamento">Condicionamento</label>
                </div>
                <div class="goal-checkbox">
                  <input type="checkbox" id="saude" name="fitness.goals" value="saude">
                  <label for="saude">Saúde Geral</label>
                </div>
                <div class="goal-checkbox">
                  <input type="checkbox" id="forca" name="fitness.goals" value="forca">
                  <label for="forca">Aumento de Força</label>
                </div>
              </div>
            </div>

            <div class="btn-group">
              <button type="submit" class="btn btn-primary">Salvar Alterações</button>
              <button type="button" id="change-password-btn" class="btn btn-secondary">Alterar Senha</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal para alterar senha -->
  <div id="password-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: rgba(26, 26, 26, 0.95); padding: 30px; border-radius: 12px; border: 1px solid rgba(188, 19, 254, 0.3); max-width: 400px; width: 90%;">
      <h3 style="color: #bc13fe; margin-bottom: 20px;">Alterar Senha</h3>
      <form id="password-form">
        <div class="form-group">
          <label for="current-password">Senha Atual</label>
          <input type="password" id="current-password" name="currentPassword" required>
        </div>
        <div class="form-group">
          <label for="new-password">Nova Senha</label>
          <input type="password" id="new-password" name="newPassword" required>
        </div>
        <div class="form-group">
          <label for="confirm-password">Confirmar Nova Senha</label>
          <input type="password" id="confirm-password" name="confirmNewPassword" required>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-primary">Alterar Senha</button>
          <button type="button" id="cancel-password" class="btn btn-secondary">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // API Base URL
    const API_BASE = 'http://localhost:3000/api';

    // Elementos DOM
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const profileContent = document.getElementById('profile-content');
    const passwordModal = document.getElementById('password-modal');
    const profileForm = document.getElementById('profile-form');
    const passwordForm = document.getElementById('password-form');

    // Verificar autenticação
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Headers para requisições autenticadas
    const headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    };

    // Carregar dados do perfil
    async function loadProfile() {
      try {
        showLoading();

        const response = await fetch(`${API_BASE}/auth/profile`, { headers });

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
            return;
          }
          throw new Error('Erro ao carregar perfil');
        }

        const data = await response.json();
        const user = data.data.user;

        populateProfile(user);
        hideLoading();
        showProfileContent();

      } catch (error) {
        console.error('Erro:', error);
        showError('Erro ao carregar perfil. Tente novamente.');
        hideLoading();
      }
    }

    // Preencher dados do perfil
    function populateProfile(user) {
      document.getElementById('user-name').textContent = user.name;
      document.getElementById('user-email').textContent = user.email;

      // Estatísticas
      document.getElementById('workouts-completed').textContent = user.stats.workoutsCompleted;
      document.getElementById('total-time').textContent = `${Math.floor(user.stats.totalTime / 60)}h`;
      document.getElementById('current-streak').textContent = user.stats.streak;
      document.getElementById('user-bmi').textContent = user.bmi || '--';

      // Assinatura
      document.getElementById('subscription-plan').textContent = getPlanName(user.subscription.plan);
      document.getElementById('subscription-status').textContent = user.subscription.status.toUpperCase();
      document.getElementById('subscription-status').className = `status-badge ${user.subscription.status === 'ativo' ? 'status-active' : 'status-inactive'}`;

      const startDate = user.subscription.startDate ? new Date(user.subscription.startDate).toLocaleDateString('pt-BR') : 'N/A';
      const endDate = user.subscription.endDate ? new Date(user.subscription.endDate).toLocaleDateString('pt-BR') : 'N/A';
      document.getElementById('subscription-dates').textContent = `De ${startDate} até ${endDate}`;

      // Formulário
      document.getElementById('name').value = user.name || '';
      document.getElementById('bio').value = user.profile?.bio || '';
      document.getElementById('location').value = user.profile?.location || '';
      document.getElementById('website').value = user.profile?.website || '';
      document.getElementById('height').value = user.fitness?.height || '';
      document.getElementById('weight').value = user.fitness?.weight || '';
      document.getElementById('birthDate').value = user.fitness?.birthDate ? new Date(user.fitness.birthDate).toISOString().split('T')[0] : '';
      document.getElementById('level').value = user.fitness?.level || 'iniciante';

      // Objetivos
      const goals = user.fitness?.goals || [];
      document.querySelectorAll('input[name="fitness.goals"]').forEach(checkbox => {
        checkbox.checked = goals.includes(checkbox.value);
      });
    }

    // Obter nome do plano
    function getPlanName(plan) {
      const plans = {
        'basico': 'Básico',
        'premium': 'Premium',
        'black': 'Black'
      };
      return plans[plan] || 'Nenhum';
    }

    // Atualizar perfil
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(profileForm);
      const data = {};

      // Processar dados do formulário
      for (let [key, value] of formData.entries()) {
        if (key === 'fitness.goals') {
          if (!data.fitness) data.fitness = {};
          if (!data.fitness.goals) data.fitness.goals = [];
          data.fitness.goals.push(value);
        } else if (key.includes('.')) {
          const [parent, child] = key.split('.');
          if (!data[parent]) data[parent] = {};
          data[parent][child] = value;
        } else {
          data[key] = value;
        }
      }

      // Converter valores numéricos
      if (data.fitness) {
        if (data.fitness.height) data.fitness.height = parseFloat(data.fitness.height);
        if (data.fitness.weight) data.fitness.weight = parseFloat(data.fitness.weight);
      }

      try {
        showLoading();

        const response = await fetch(`${API_BASE}/auth/profile`, {
          method: 'PUT',
          headers,
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          throw new Error('Erro ao atualizar perfil');
        }

        const result = await response.json();
        showSuccess('Perfil atualizado com sucesso!');
        loadProfile(); // Recarregar dados

      } catch (error) {
        console.error('Erro:', error);
        showError('Erro ao atualizar perfil. Tente novamente.');
      } finally {
        hideLoading();
      }
    });

    // Alterar senha
    passwordForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(passwordForm);
      const data = Object.fromEntries(formData.entries());

      try {
        showLoading();

        const response = await fetch(`${API_BASE}/auth/change-password`, {
          method: 'PUT',
          headers,
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Erro ao alterar senha');
        }

        showSuccess('Senha alterada com sucesso!');
        hidePasswordModal();

      } catch (error) {
        console.error('Erro:', error);
        showError(error.message);
      } finally {
        hideLoading();
      }
    });

    // Event listeners
    document.getElementById('change-password-btn').addEventListener('click', showPasswordModal);
    document.getElementById('cancel-password').addEventListener('click', hidePasswordModal);

    // Funções utilitárias
    function showLoading() {
      loading.style.display = 'flex';
    }

    function hideLoading() {
      loading.style.display = 'none';
    }

    function showProfileContent() {
      profileContent.style.display = 'block';
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
    }

    function showPasswordModal() {
      passwordModal.style.display = 'flex';
    }

    function hidePasswordModal() {
      passwordModal.style.display = 'none';
      passwordForm.reset();
    }

    // Menu mobile (igual ao index.html)
    document.addEventListener('DOMContentLoaded', function() {
      const profileBtn = document.getElementById('profile-btn');
      const profileMenu = document.getElementById('profile-menu');

      if (profileBtn && profileMenu) {
        profileBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          const isExpanded = this.getAttribute('aria-expanded') === 'true';

          if (!isExpanded) {
            profileMenu.classList.add('show');
            this.setAttribute('aria-expanded', 'true');
          } else {
            profileMenu.classList.remove('show');
            this.setAttribute('aria-expanded', 'false');
          }
        });

        document.addEventListener('click', function(event) {
          if (!profileBtn.contains(event.target) && !profileMenu.contains(event.target)) {
            profileMenu.classList.remove('show');
            profileBtn.setAttribute('aria-expanded', 'false');
          }
        });
      }

      // Carregar perfil
      loadProfile();
    });
  </script>
</body>
</html>
